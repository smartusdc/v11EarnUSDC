import React, { useState, useEffect } from 'react';
import { AlertTriangle, CheckCircle } from 'lucide-react';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';

const AdminDashboard = () => {
  // States for form inputs
  const [newAPR, setNewAPR] = useState('');
  const [referrerRate, setReferrerRate] = useState('');
  const [referredRate, setReferredRate] = useState('');
  const [accountToFreeze, setAccountToFreeze] = useState('');
  const [emergencyWithdrawAmount, setEmergencyWithdrawAmount] = useState('');
  const [balanceSummary, setBalanceSummary] = useState(null);
  const [notification, setNotification] = useState({ type: '', message: '' });
  const [isConnected, setIsConnected] = useState(false);
  const [userAddress, setUserAddress] = useState('');
  const [contract, setContract] = useState(null);
  const [web3, setWeb3] = useState(null);

  useEffect(() => {
    initWeb3();
  }, []);

  const initWeb3 = async () => {
    if (window.ethereum) {
      const Web3 = window.Web3;
      const web3Instance = new Web3(window.ethereum);
      setWeb3(web3Instance);

      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const userAddr = accounts[0];
        setUserAddress(userAddr);
        setIsConnected(true);

        const contractInstance = new web3Instance.eth.Contract(
          CONTRACT_ABI,
          CONTRACT_ADDRESS
        );
        setContract(contractInstance);
        
        // Load initial balance summary
        await updateBalanceSummary(contractInstance);
      } catch (error) {
        showNotification('error', 'Failed to connect wallet: ' + error.message);
      }
    } else {
      showNotification('error', 'Please install MetaMask!');
    }
  };

  const updateBalanceSummary = async (contractInstance) => {
    try {
      const summary = await contractInstance.methods.getBalanceSummary().call();
      setBalanceSummary({
        contractBalance: web3.utils.fromWei(summary.contractBalance, 'mwei'),
        totalDeposits: web3.utils.fromWei(summary.totalDepositAmount, 'mwei'),
        totalRewards: web3.utils.fromWei(summary.totalRewardAmount, 'mwei'),
        totalReferralRewards: web3.utils.fromWei(summary.totalReferralAmount, 'mwei')
      });
    } catch (error) {
      showNotification('error', 'Failed to fetch balance summary');
    }
  };

  const showNotification = (type, message) => {
    setNotification({ type, message });
    setTimeout(() => setNotification({ type: '', message: '' }), 5000);
  };

  const handleSetAPR = async () => {
    try {
      await contract.methods.setAPR(Math.floor(parseFloat(newAPR) * 100))
        .send({ from: userAddress });
      showNotification('success', 'APR updated successfully');
      setNewAPR('');
    } catch (error) {
      showNotification('error', 'Failed to update APR: ' + error.message);
    }
  };

  const handleSetReferralRates = async () => {
    try {
      await contract.methods.setReferralRewardRates(
        Math.floor(parseFloat(referrerRate) * 100),
        Math.floor(parseFloat(referredRate) * 100)
      ).send({ from: userAddress });
      showNotification('success', 'Referral rates updated successfully');
      setReferrerRate('');
      setReferredRate('');
    } catch (error) {
      showNotification('error', 'Failed to update referral rates: ' + error.message);
    }
  };

  const handleTogglePause = async (type) => {
    try {
      const method = `toggle${type}Pause`;
      await contract.methods[method]().send({ from: userAddress });
      showNotification('success', `${type} toggle successful`);
    } catch (error) {
      showNotification('error', `Failed to toggle ${type}: ` + error.message);
    }
  };

  const handleFreezeAccount = async () => {
    if (!web3.utils.isAddress(accountToFreeze)) {
      showNotification('error', 'Invalid address format');
      return;
    }

    try {
      await contract.methods.setAccountFrozen(accountToFreeze, true)
        .send({ from: userAddress });
      showNotification('success', 'Account frozen successfully');
      setAccountToFreeze('');
    } catch (error) {
      showNotification('error', 'Failed to freeze account: ' + error.message);
    }
  };

  const handleEmergencyWithdraw = async () => {
    try {
      const amountWei = web3.utils.toWei(emergencyWithdrawAmount, 'mwei');
      await contract.methods.emergencyWithdraw(amountWei)
        .send({ from: userAddress });
      showNotification('success', 'Emergency withdrawal successful');
      setEmergencyWithdrawAmount('');
      await updateBalanceSummary(contract);
    } catch (error) {
      showNotification('error', 'Failed to perform emergency withdrawal: ' + error.message);
    }
  };

  if (!isConnected) {
    return (
      <div className="p-4">
        <Alert variant="destructive">
          <AlertTriangle className="h-4 w-4" />
          <AlertTitle>Error</AlertTitle>
          <AlertDescription>
            Please connect your wallet to access the admin dashboard.
          </AlertDescription>
        </Alert>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto p-4 space-y-6">
      <h1 className="text-3xl font-bold mb-6">Admin Dashboard</h1>

      {notification.message && (
        <Alert variant={notification.type === 'error' ? 'destructive' : 'default'}>
          {notification.type === 'error' ? (
            <AlertTriangle className="h-4 w-4" />
          ) : (
            <CheckCircle className="h-4 w-4" />
          )}
          <AlertTitle>{notification.type === 'error' ? 'Error' : 'Success'}</AlertTitle>
          <AlertDescription>{notification.message}</AlertDescription>
        </Alert>
      )}

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle>Contract Summary</CardTitle>
          </CardHeader>
          <CardContent>
            {balanceSummary && (
              <div className="space-y-2">
                <p>Contract Balance: {balanceSummary.contractBalance} USDC</p>
                <p>Total Deposits: {balanceSummary.totalDeposits} USDC</p>
                <p>Total Rewards: {balanceSummary.totalRewards} USDC</p>
                <p>Total Referral Rewards: {balanceSummary.totalReferralRewards} USDC</p>
              </div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Update APR</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <input
                type="number"
                value={newAPR}
                onChange={(e) => setNewAPR(e.target.value)}
                placeholder="New APR (%)"
                className="w-full p-2 border rounded"
              />
              <button
                onClick={handleSetAPR}
                className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
              >
                Set APR
              </button>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Referral Rates</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <input
                type="number"
                value={referrerRate}
                onChange={(e) => setReferrerRate(e.target.value)}
                placeholder="Referrer Rate (%)"
                className="w-full p-2 border rounded"
              />
              <input
                type="number"
                value={referredRate}
                onChange={(e) => setReferredRate(e.target.value)}
                placeholder="Referred Rate (%)"
                className="w-full p-2 border rounded"
              />
              <button
                onClick={handleSetReferralRates}
                className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
              >
                Update Rates
              </button>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Contract Controls</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-2">
              <button
                onClick={() => handleTogglePause('Deposit')}
                className="w-full bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600"
              >
                Toggle Deposit Pause
              </button>
              <button
                onClick={() => handleTogglePause('Withdrawal')}
                className="w-full bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600"
              >
                Toggle Withdrawal Pause
              </button>
              <button
                onClick={() => handleTogglePause('RewardClaim')}
                className="w-full bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600"
              >
                Toggle Reward Claim Pause
              </button>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Account Management</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <input
                type="text"
                value={accountToFreeze}
                onChange={(e) => setAccountToFreeze(e.target.value)}
                placeholder="Account Address"
                className="w-full p-2 border rounded"
              />
              <button
                onClick={handleFreezeAccount}
                className="w-full bg-red-500 text-white p-2 rounded hover:bg-red-600"
              >
                Freeze Account
              </button>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Emergency Withdraw</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <input
                type="number"
                value={emergencyWithdrawAmount}
                onChange={(e) => setEmergencyWithdrawAmount(e.target.value)}
                placeholder="Amount (USDC)"
                className="w-full p-2 border rounded"
              />
              <button
                onClick={handleEmergencyWithdraw}
                className="w-full bg-red-500 text-white p-2 rounded hover:bg-red-600"
              >
                Emergency Withdraw
              </button>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
};

const CONTRACT_ADDRESS = '0x708A8Fc8ccaDaB721388a4ABc99581AE3fd19e6F';
const CONTRACT_ABI = [
  // Contract ABI from your smart contract
  {"inputs":[{"name":"_newAPR","type":"uint256"}],"name":"setAPR","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"name":"_referrerRate","type":"uint256"},{"name":"_referredRate","type":"uint256"}],"name":"setReferralRewardRates","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"toggleDepositPause","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"toggleWithdrawalPause","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"toggleRewardClaimPause","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"name":"account","type":"address"},{"name":"frozen","type":"bool"}],"name":"setAccountFrozen","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"name":"amount","type":"uint256"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"getBalanceSummary","outputs":[{"name":"contractBalance","type":"uint256"},{"name":"totalDepositAmount","type":"uint256"},{"name":"totalRewardAmount","type":"uint256"},{"name":"totalReferralAmount","type":"uint256"}],"stateMutability":"view","type":"function"}
];

export default AdminDashboard;
