<!-- HTML部分の修正 -->
<!-- stats部分を修正 -->
<div class="stats">
    <div class="card">
        <h3>Your Statistics</h3>
        <p>Balance: <span id="userBalance">0</span> USDC</p>
        <p>Staked: <span id="stakedAmount">0</span> USDC</p>
        <p>Pending Rewards: <span id="pendingRewards">0</span> USDC</p>
    </div>
    <div class="card">
        <h3>Referral Statistics</h3>
        <p>Total Referrals: <span id="totalReferrals">0</span></p>
        <p>Referral Rewards: <span id="referralRewards">0</span> USDC</p>
    </div>
</div>

<!-- JavaScript部分の修正 -->
<script>
// updateUI関数の修正
async function updateUI() {
    if (!userAddress) return;
    
    try {
        showLoading(true);
        
        // Get USDC balance
        const balance = await usdcContract.methods.balanceOf(userAddress).call();
        document.getElementById('userBalance').textContent = 
            formatNumber(web3.utils.fromWei(balance, 'mwei'));
        showDebugInfo('USDC Balance: ' + web3.utils.fromWei(balance, 'mwei'));

        // リファラル状態の確認
        const referralCode = await contract.methods.userToReferralCode(userAddress).call();
        const referralInput = document.getElementById('referralCode');
        if (referralInput) {
            referralInput.style.display = referralCode === '0' ? 'block' : 'none';
        }

        // Get staked amount
        const staked = await contract.methods.deposits(userAddress).call();
        document.getElementById('stakedAmount').textContent = 
            formatNumber(web3.utils.fromWei(staked, 'mwei'));
        showDebugInfo('Staked Amount: ' + web3.utils.fromWei(staked, 'mwei'));

        // Get user info for total referrals
        const userInfo = await contract.methods.getUserInfo(userAddress).call();
        document.getElementById('totalReferrals').textContent = userInfo.totalReferrals;

        // Get pending rewards
        const rewards = await contract.methods.calculateReward(userAddress).call();
        document.getElementById('pendingRewards').textContent = 
            formatNumber(web3.utils.fromWei(rewards, 'mwei'));
        showDebugInfo('Pending Rewards: ' + web3.utils.fromWei(rewards, 'mwei'));

        // Get referral rewards
        const referralRewards = await contract.methods.referralRewards(userAddress).call();
        document.getElementById('referralRewards').textContent = 
            formatNumber(web3.utils.fromWei(referralRewards, 'mwei'));
        showDebugInfo('Referral Rewards: ' + web3.utils.fromWei(referralRewards, 'mwei'));

        // Update referral code
        await updateReferralCode();

    } catch (error) {
        console.error('Error updating UI:', error);
        showAlert('Error updating data', 'error');
        showDebugInfo('UI update error: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// CONTRACT_ABIからランク関連の関数を削除
const CONTRACT_ABI = [
    {
        "inputs": [{"name": "","type": "address"}],
        "name": "deposits",
        "outputs": [{"name": "","type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [{"name": "","type": "address"}],
        "name": "calculateReward",
        "outputs": [{"name": "","type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [{"name": "user","type": "address"}],
        "name": "getUserInfo",
        "outputs": [
            {"name": "depositAmount","type": "uint256"},
            {"name": "pendingRewards","type": "uint256"},
            {"name": "userReferralRewards","type": "uint256"},
            {"name": "totalReferrals","type": "uint256"},
            {"name": "isFrozen","type": "bool"}
        ],
        "stateMutability": "view",
        "type": "function"
    },
    // ... その他の既存のABI定義
];
</script>
